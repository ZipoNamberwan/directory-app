# Linux Dev Docker Setup
services:
  app:
    volumes:
      - .:/var/www
      - /var/www/vendor
      - /var/www/node_modules
      - /var/www/bootstrap/cache
      - /var/www/storage/logs
      - /var/www/storage/framework
      - ./docker/php/php-dev.ini:/usr/local/etc/php/php.ini
      - ./docker/supervisor/laravel-workers-dev.conf:/etc/supervisor/conf.d/laravel-workers.conf
      - ./backup:/var/www/backup
      - storagedata:/var/www/storage/app
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      APP_LOG_LEVEL: debug
    entrypoint:
      - bash
      - -c
      - |
        echo 'Fixing permissions...'
        chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache /var/www/public
        chmod -R 775 /var/www/storage /var/www/bootstrap/cache /var/www/public
        mkdir -p /var/www/storage/logs
        touch /var/www/storage/logs/laravel.log
        chown www-data:www-data /var/www/storage/logs/laravel.log
        chmod 664 /var/www/storage/logs/laravel.log
        echo 'Starting supervisord...'
        exec supervisord -c /etc/supervisor/supervisord.conf

# # Windows Dev Docker Setup (uncomment to use)
# services:
#   app:
#     # Mount Laravel source code for live reload
#     volumes:
#       - .:/var/www
#       - ./docker/php/php.ini:/usr/local/etc/php/php.ini
#       - ./backup:/var/www/backup
#       - storagedata:/var/www/storage/app
#     environment:
#       APP_ENV: local
#       APP_DEBUG: "true"
#       APP_LOG_LEVEL: debug
db:
    volumes:
      - ./docker/mysql/my-dev.cnf:/etc/mysql/conf.d/my.cnf:ro
    deploy:
      resources:
        limits:
          memory: 8g
